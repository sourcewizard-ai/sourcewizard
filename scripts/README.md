# Scripts Documentation

## Registry Config Importer

The `insert-registry-configs.ts` script imports package configurations from JSON files in the `registry/out/` directory into the Supabase `packages` table.

### Overview

This script:

- Recursively scans the `registry/out/` directory for `pkg.json` files
- Validates and maps JSON data to the Supabase packages table schema
- Automatically authenticates with Supabase using session tokens
- Uses upsert operations to handle existing packages
- Provides clean error handling and logging
- Handles Row Level Security (RLS) policies correctly

### Usage

#### Basic Usage

```bash
# Import configs using session info
npm run import-registry

# Or run directly with tsx
tsx scripts/insert-registry-configs.ts
```

#### Options

| Option                   | Description                    | Required | Default        |
| ------------------------ | ------------------------------ | -------- | -------------- |
| `--registry-path=<path>` | Path to registry directory     | âŒ No    | `registry/out` |
| `--dry-run`              | Preview without inserting data | âŒ No    | `false`        |

#### Examples

```bash
# Dry run to preview what would be imported
npm run import-registry:dry-run

# Import using session info
npm run import-registry

# Import from custom path
npm run import-registry -- --registry-path=custom/path
```

### JSON File Format

The script expects `pkg.json` files with the following structure:

```json
{
  "name": "package-name", // Required
  "description": "Package description", // Required
  "language": "typescript", // Required
  "env": ["ENV_VAR_1", "ENV_VAR_2"], // Optional
  "packages": ["@scope/package"], // Optional
  "tags": ["tag1", "tag2"], // Optional
  "relevant_files_pattern": ["**/file.ts"], // Optional
  "setup_prompt": "Setup instructions..." // Optional
}
```

### Data Mapping

| JSON Field               | Supabase Field           | Notes                              |
| ------------------------ | ------------------------ | ---------------------------------- |
| `name`                   | `name`                   | Direct mapping                     |
| `description`            | `description`            | Direct mapping                     |
| `language`               | `language`               | Direct mapping                     |
| `tags`                   | `tags`                   | Array field                        |
| `relevant_files_pattern` | `relevant_files_pattern` | Array field                        |
| `setup_prompt`           | `setup_prompt`           | Optional text field                |
| `env` + `packages`       | `metadata`               | Combined into JSONB metadata field |
| -                        | `user_id`                | Provided via CLI argument          |
| -                        | `created_at`             | Auto-generated by database         |
| -                        | `updated_at`             | Auto-generated by database         |

### Error Handling

The script provides detailed error reporting:

- âœ… **File validation**: Skips files missing required fields
- âœ… **UUID validation**: Validates user ID format
- âœ… **Path validation**: Checks if registry path exists
- âœ… **Database errors**: Reports Supabase insertion errors
- âœ… **Summary reporting**: Shows success/failure counts

### Output Example

```
ğŸ¯ Registry Config Importer
==========================
ğŸ‘¤ User: ivan@typeconf.dev
ğŸ“ Registry Path: registry/out
ğŸ§ª Dry Run: No

ğŸ“„ Found 2 config files
ğŸ“¦ Processing 2 packages: mailchimp, clerk
ğŸš€ Upserting 2 packages...

ğŸ“Š Summary:
âœ… Successfully processed: 2
âŒ Failed: 0

ğŸ‰ Import completed successfully!
```

### Authentication

The script automatically uses your authenticated session:

1. **Session file**: `~/.config/sourcewizard/auth.json`
2. **Login first**: Use your app's login flow to create a session
3. **Automatic**: Script reads user info and auth tokens from session

### Troubleshooting

#### Common Issues

**"No valid session found"**

- Log in to your app first to create a session file
- Check that `~/.config/sourcewizard/auth.json` exists and is not expired

**"Registry path does not exist"**

- Check that the specified path contains `pkg.json` files
- Use `--registry-path` to specify a different location

**"Missing required fields"**

- Ensure JSON files have `name`, `description`, and `language` fields
- Check JSON syntax with a validator

**Supabase connection errors**

- Verify Supabase credentials in `src/shared/supabase-client.ts`
- Check network connectivity
- Ensure the `packages` table exists and has correct permissions

### Development

To modify the script:

1. Edit `scripts/insert-registry-configs.ts`
2. Update interfaces if changing data structure
3. Test with `--dry-run` before live changes
4. Update this documentation if adding new features
