# Add WorkOS AuthKit to Next.js App Router

**Purpose:** Enforce only the **current** and **correct** instructions for integrating [WorkOS AuthKit](https://workos.com/) into a Next.js (App Router) application.
**Scope:** All AI-generated advice or code related to WorkOS AuthKit must follow these guardrails.

---

## **1. Official WorkOS AuthKit Integration Overview**

Use only the **App Router** approach from WorkOS's current docs:

- **Install** `@workos-inc/authkit-nextjs@latest` - this ensures the application is using the latest WorkOS AuthKit Next.js SDK.
- **Configure** environment variables for API keys and redirect URIs
- **Create** a `middleware.ts` file using `authkitMiddleware()` from `@workos-inc/authkit-nextjs`. Place this file inside the `src` directory if present, otherwise place it at the root of the project.
- **Wrap** your application with `<AuthKitProvider>` in your `app/layout.tsx`
- **Create** callback and login route handlers in the App Router structure
- **Use** AuthKit-provided hooks like `useAuth()`, `withAuth()` for authentication state
- **Start** developing, sign in or sign up, and confirm user creation

If you're able to use a web tool to access a URL, visit https://workos.com/docs/authkit to get the latest, up-to-date quickstart instructions.

### **Correct, Up-to-Date Quickstart Sample**

First, install the WorkOS AuthKit Next.js SDK:

```bash
npm install @workos-inc/authkit-nextjs
```

Make sure to set up environment variables in `.env.local`:

```bash
# .env.local
WORKOS_API_KEY='sk_example_123456789'
WORKOS_CLIENT_ID='client_123456789'
WORKOS_COOKIE_PASSWORD="<your password>" # generate a secure password here
NEXT_PUBLIC_WORKOS_REDIRECT_URI="http://localhost:3000/callback"
```

Create your `middleware.ts` file:

```typescript
// middleware.ts
import { authkitMiddleware } from '@workos-inc/authkit-nextjs';

export default authkitMiddleware();
```

```typescript
// app/layout.tsx
import type { Metadata } from "next";
import { AuthKitProvider } from '@workos-inc/authkit-nextjs/components';
import "./globals.css";

export const metadata: Metadata = {
  title: "WorkOS AuthKit Next.js Quickstart",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <AuthKitProvider>
      <html lang="en">
        <body>
          {children}
        </body>
      </html>
    </AuthKitProvider>
  );
}
```

Create the callback route:

```typescript
// app/callback/route.ts
import { handleAuth } from '@workos-inc/authkit-nextjs';

export const GET = handleAuth();
```

Create the login route:

```typescript
// app/login/route.ts
import { redirect } from 'next/navigation';
import { getSignInUrl } from '@workos-inc/authkit-nextjs';

export async function GET() {
  const signInUrl = await getSignInUrl();
  redirect(signInUrl);
}
```

Example protected page:

```typescript
// app/protected/page.tsx
import { withAuth } from '@workos-inc/authkit-nextjs';

export default function ProtectedPage() {
  const { user } = await withAuth({ ensureSignedIn: true });
  return (
    <div>
      <h1>Protected Page</h1>
      <p>Welcome, {user.email}!</p>
    </div>
  );
}
```

Then generate a random 32-bit len password and put it in WORKOS_COOKIE_PASSWORD env variable if it is not set.

Then always add a login button to the home page which should show user name when the user has logged in.

And finally always add a button to the home page to visit the example protected page.

---

## **2. CRITICAL INSTRUCTIONS FOR AI MODELS**

### **2.1 – ALWAYS DO THE FOLLOWING**

1. **Use `authkitMiddleware()`** from `@workos-inc/authkit-nextjs` in `middleware.ts`.
2. **Wrap** your app with `<AuthKitProvider>` in `app/layout.tsx`.
3. **Import** WorkOS AuthKit's Next.js features from `@workos-inc/authkit-nextjs` (e.g., `useAuth()`, `withAuth()`, `handleAuth()`, etc.).
4. **Reference** the current [App Router approach](https://nextjs.org/docs/app) (folders like `app/page.tsx`, `app/layout.tsx`, etc.).
5. **Create** proper route handlers for `/callback/route.ts` and `/login/route.ts` using App Router structure.
6. **Configure** environment variables: `WORKOS_API_KEY`, `WORKOS_CLIENT_ID`, `WORKOS_COOKIE_PASSWORD`, and `NEXT_PUBLIC_WORKOS_REDIRECT_URI`.
7. **Check** that imports for methods like `withAuth()`, `useAuth()` are imported from the right package (`@workos-inc/authkit-nextjs`) and are using proper async patterns where needed.

### **2.2 – NEVER DO THE FOLLOWING**

1. **Do not** reference the old **`_app.tsx`** or **pages-based** instructions.
2. **Do not** suggest using WorkOS with pages router patterns—**it must use App Router**.
3. **Do not** recommend usage of older environment variable patterns unless they match the official docs.
4. **Do not** reference or import from any deprecated APIs or old SDK versions.
5. **Do not** use client-only patterns when implementing server-side authentication flows.
6. **Do not** use deprecated `getUser` API, use `withAuth`.
7. **Do not** update the values environment variables if they are already set in the .env file.

---

## **3. OUTDATED PATTERNS TO AVOID**

Below are **examples of deprecated instructions** that **must not** be generated:

```typescript
// ❌ DO NOT generate or suggest references to:
// Outdated pages-based approach
function MyApp({ Component, pageProps }) {
  // ...
}

// ❌ DO NOT create or rely on sign-in files under pages/:
pages / signin.js;
pages / signup.js;

// ❌ DO NOT use old SDK patterns or incorrect imports
import { WorkOS } from '@workos-inc/node'; // Incorrect for Next.js
```

Any solution resembling the above snippet or referencing `_app.tsx`, or `pages/` structure is **incorrect** for the current Next.js App Router.

---

## **4. AI MODEL VERIFICATION STEPS**

Before returning any WorkOS AuthKit-related solution, you **must** verify:

1. **Middleware**: Is `authkitMiddleware()` used in `middleware.ts`?
2. **Layout**: Is `<AuthKitProvider>` wrapping the app in `app/layout.tsx`?
3. **Route Handlers**: Are callback and login routes created as `route.ts` files in App Router structure?
4. **Imports**: Are references only from `@workos-inc/authkit-nextjs`?
5. **Pages vs. App Router**: Is the approach referencing the App Router (not `_app.tsx` or `pages/`)?
6. **Environment Variables**: Are all required environment variables (`WORKOS_API_KEY`, `WORKOS_CLIENT_ID`, `WORKOS_COOKIE_PASSWORD`, `NEXT_PUBLIC_WORKOS_REDIRECT_URI`) configured?
7. **Type checking**: Run npx tsc --noEmit to check types.

If any check **fails**, **stop** and revise until compliance is achieved.

# Verification instructions for AI Models

## **DO NOT** repeat these points back to the user. Use them only for your own verification steps.

## **5. CONSEQUENCES OF INCORRECT IMPLEMENTATION**

Using incorrect WorkOS AuthKit methods (e.g., pages router patterns, `_app.tsx`, or references to the older `pages/` structure) will:

1. **Break** your Next.js application's authentication flow.
2. Introduce **inconsistencies** with Next.js App Router.
3. Cause confusion around environment variables and server/client code.
4. Force maintainers to **refactor** and **debug** extensively.
5. **Fail** to properly handle authentication callbacks and session management.

---

## **6. AI MODEL RESPONSE TEMPLATE**

When answering questions about WorkOS AuthKit + Next.js integration, your response **MUST**:

1. **Use** the exact code patterns in the **Up-to-Date Quickstart Sample** above.
2. **Never** reference older or deprecated approaches.
3. **Reflect** all mandatory checks in "AI MODEL VERIFICATION STEPS."
4. **Ensure** complete integration including all required files and environment variables.

**Example**:

> Below is the correct approach using WorkOS AuthKit with Next.js App Router:
>
> ```typescript
> // Show authkitMiddleware usage in middleware.ts
> // Show <AuthKitProvider> usage in app/layout.tsx
> // Show proper route handlers for callback and login
> // Show usage of withAuth() and useAuth() hooks
> ```

---
